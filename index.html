<!-- index.html (Angepasst für Hybrid-Modus) -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Live Paket Visualisierung mit p5.js</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
    #download-button {
      position: absolute; bottom: 20px; left: 20px;
      padding: 12px 24px; background: #007bff; color: #fff;
      border: none; border-radius: 8px; font-size: 16px;
      cursor: pointer; z-index: 100;
    }
    #download-button:disabled { background: #555; cursor: not-allowed; }
  </style>
</head>
<body>
  <button id="download-button">Download starten</button>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof p5 === 'undefined') {
        document.body.innerHTML = '<h1 style="color:red;">Fehler: p5.js konnte nicht geladen werden.</h1>';
        return;
      }
      
      let strokes = [];

      window.setup = function() {
        createCanvas(windowWidth, windowHeight);
        background(0);
      }

      window.windowResized = function() { resizeCanvas(windowWidth, windowHeight); }

      window.draw = function() {
        background(0, 60); // Hintergrund mit Nachzieheffekt
        for (let i = strokes.length - 1; i >= 0; i--) {
          let s = strokes[i];
          stroke(s.color);
          strokeWeight(s.weight);
          line(s.x, s.y, s.x - s.length, s.y);
          s.x -= s.speed;
          if (s.x + s.length < 0) { strokes.splice(i, 1); }
        }
      }

      // Funktion zum Hinzufügen einer Linie, jetzt mit Typ-Unterscheidung
      function addStroke(type) {
        let s;
        if (type === 'download') {
          // Download-Pakete: Helle, schnelle, dicke Linien
          s = {
            x: width + 50, y: random(height), length: random(150, 300),
            speed: random(8, 15),
            color: color(random(80, 200), random(50, 150), 255, 200),
            weight: 3
          };
        } else {
          // tshark-Pakete (Hintergrund): Dunklere, langsamere
         s = {
  x: width + 50,
  y: random(height),
  length: random(80, 180), // etwas länger als vorher
  speed: random(3, 5),
  color: color(
    random(100, 255), // bunteres Spektrum
    random(100, 255),
    random(100, 255),
    200 // kräftiger, aber nicht zu grell
  ),
  weight: 2.5 // ggf. etwas dünner als Download
};

        }
        strokes.push(s);
      }
      
      function startDownloadAction() {
        const button = document.getElementById("download-button");
        if(button.disabled) return;
        button.textContent = "Download läuft...";
        button.disabled = true;
        window.location.href = '/start-download';
        setTimeout(() => {
          button.textContent = "Download erneut starten";
          button.disabled = false;
        }, 20000);
      }

      document.getElementById("download-button").addEventListener("click", startDownloadAction);

      const ws = new WebSocket('ws://localhost:3000');
      
      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          
          if (msg.type === 'START_DOWNLOAD') {
            startDownloadAction();
          } else if (msg.type === 'tshark-packet') {
            addStroke('tshark'); // Hintergrundpaket
          } else if (msg.type === 'download-packet') {
            addStroke('download'); // Download-Paket
          }
        } catch(e) {
          // Einfache Nachrichten vom alten Server ignorieren
        }
      };

      ws.onopen = () => console.log("STATUS: WebSocket-Verbindung ist offen.");
    });
  </script>
</body>
</html>